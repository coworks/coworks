<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC
"-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="board">

	<resultMap id="boardMap" type="map"/>
	<resultMap id="attachmentMap" type="attachment" />

	<!-- ********************자료실 업무자료 ******************** -->
	<!-- 게시글 목록 조회 -->
	<select id="selectBusinessdocList" resultType="board">
		SELECT B.*, (SELECT COUNT(*) 
		             FROM ATTACHMENT 
		             WHERE B.BOARDNO = BOARDNO) FILECOUNT
		FROM BOARD B
		ORDER BY BOARDDATE DESC 
		
	</select>
	
	<!-- 게시글 개수 카운트 -->
	<select id="selectBusinessdocTotalContents" resultType="_int">
		SELECT COUNT(*) FROM BOARD
	</select>
	
	<!-- 게시글 한 개 조회 -->
	<select id="selectOneBusinessdocdetail" 
	        parameterType="_int" 
	        resultType="board">
	        SELECT * 
	        FROM BOARD
	        WHERE BOARDNO = #{boardNo}	
	</select>
	
	<!-- 게시글 입력 -->
	<insert id="insertBusinessdoc">
		INSERT INTO BOARD(BOARDNO, BOARDTITLE, BOARDWRITER, BOARDCONTENT)
		VALUES (SEQ_BOARDNO.NEXTVAL, #{boardTitle}, 
		        #{boardWriter}, #{boardContent})
		
		<!-- board 객체를 insert에서 전달하여 SQL을 실행한 뒤,
			 board 객체에 select한 게시글 번호를 주입받아 돌아온다. -->
		<!-- 1번) -->
		<selectKey keyProperty="boardNo" resultType="_int" order="AFTER">
			SELECT SEQ_BOARDNO.CURRVAL FROM DUAL
		</selectKey>
		<!-- selectKey : 특정 쿼리가 끝난 이후에 기본키로 꺼내와야 할 것들을 따로 꺼내오는 부가적인 쿼리를 짤 수 있다. -->
		<!-- boardNo라는 것을 resultType으로 int꺼내오게 하면서 order(언제수행할거냐, insert가 끝난 후 추가적으로 넣을게요) -->
		
		<!-- 위의 쿼리는 하고, 그냥 끝나는게 아니라 부가 쿼리 실행하고 결과는 위의 쿼리만 보여주지만 내부적으로 부가쿼리를 보유하고 있다. -->
	</insert>

	<!-- 게시글 -> 첨부파일 넣기 -->
	<insert id="insertBusinessdocAttach">
		<!-- 2번) 알아서 현재값 찾아 boardNo넣어서 아래의 INSERT의 #{boardNo}로 들고온다. -->
		<selectKey keyProperty="boardNo" resultType="_int" order="BEFORE">
			SELECT SEQ_BOARDNO.CURRVAL FROM DUAL
		</selectKey>
	
		INSERT INTO ATTACHMENT(ATTACHMENTNO, BOARDNO, 
		                       ORIGINALFILENAME, RENAMEDFILENAME)
		VALUES(SEQ_ATTACHMENTNO.NEXTVAL, #{boardNo}, 
		       #{originalFileName}, #{renamedFileName})
	</insert>
	<!-- ★selectkey★ : 
		1번) 게시글이 등록되면서(AFTER) 현재의 boardNo를 따로 조회한다. -> setter 사용하는 방법
		2번) 등록된 게시글에 연결된 boardNo를 가져와서(BEFORE) 첨부파일을 boardNo와 연결한다.
		두 개 중에 하나 선택해서 사용하면 됩니당 :) -->


	<!-- 게시글리스트 -->
		<select id="selectBusinessdocAttachList" parameterType="_int" resultMap="attachmentMap">
									<!-- 글번호를 받아서 attachmentMap으로 맨 위에 등록된 resultMap으로 결과를 받는다?담는다? -->
		SELECT * FROM ATTACHMENT WHERE BOARDNO = #{boardNo}
	</select>

	<!-- 게시글 수정 -->
	<update id="updateBusinessdocview" parameterType="board">
		UPDATE BOARD 
		SET BOARDTITLE = #{boardTitle},
		    BOARDCONTENT = #{boardContent}
		WHERE BOARDNO = #{boardNo}
	</update>
	
	<!-- 첨부파일 수정(이전의 파일 삭제 후 새로운 파일 추가) -->
	<insert id="updateBusinessdocAttach" parameterType="attachment">
		INSERT INTO ATTACHMENT(ATTACHMENTNO, BOARDNO, 
		                       ORIGINALFILENAME, RENAMEDFILENAME)
		VALUES(SEQ_ATTACHMENTNO.NEXTVAL, #{boardNo}, 
		       #{originalFileName}, #{renamedFileName})
	</insert>
	<!-- 이전의 파일 삭제 후 새로운 파일을 추가한다고 했는데, 삭제는 아래에 있는(첨부파일 삭제)에서 이루어지니깐 여기에서는 그냥 insert만 하면 됨. -->
	
	<!-- 게시글 삭제 -->
	<delete id="deleteBusinessdoc">
		DELETE FROM BOARD
		WHERE BOARDNO = #{boardNo}
	</delete>
	
	<!-- 첨부파일 모두 삭제(글 삭제 시) -->
	<delete id="deleteBusinessdocAttachment">
		DELETE FROM ATTACHMENT
		WHERE BOARDNO = #{boardNo}
	</delete>
	
	<!-- 첨부파일 하나 삭제 -->
	<delete id="deleteBusinessdocFile">
		DELETE FROM ATTACHMENT
		WHERE ATTACHMENTNO = #{attNo}
	</delete>













	
</mapper>
